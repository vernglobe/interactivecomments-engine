"use strict";var e=require("aws-sdk"),t=require("https"),r=require("assert");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(e),a=n(t),s=n(r),i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function c(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var u={};Object.defineProperty(u,"__esModule",{value:!0});var l=o.default,f=a.default,p=s.default;function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var h=d(l),y=d(f),b=d(p),g="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==i?i:"undefined"!=typeof self?self:{};var _={};!function(e){var t;Object.defineProperty(e,"__esModule",{value:!0}),function(e){e[e.Debug=20]="Debug",e[e.Info=30]="Info",e[e.Warn=40]="Warn",e[e.Error=50]="Error"}(t||(t={}));const r=(e,r)=>{e.level=r;const n=JSON.stringify(e);switch(r){case t.Error:console.error(n);break;case t.Warn:console.warn(n);break;case t.Info:console.log(n);break;case t.Debug:console.debug(n);break;default:console.log(n)}},n=e=>"object"==typeof e?e:{message:e};e.default=class{constructor(e){this.name=e}debug(e){r(n({message:e,name:this.name}),t.Debug)}info(e){r(n({message:e,name:this.name}),t.Info)}warn(e){r(n({message:e,name:this.name}),t.Warn)}error(e){const o=n(e);e.error&&(o.error=e.error.stack),o.reason=e.reason,r(o,t.Error)}}}(_);var v,m=function(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}(_),w=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,O=/^\w*$/,j=/^\./,S=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,E=/\\(\\)?/g,D=/^\[object .+?Constructor\]$/,k="object"==typeof g&&g&&g.Object===Object&&g,M="object"==typeof self&&self&&self.Object===Object&&self,$=k||M||Function("return this")(),C=Array.prototype,N=Function.prototype,T=Object.prototype,A=$["__core-js_shared__"],I=(v=/[^.]+$/.exec(A&&A.keys&&A.keys.IE_PROTO||""))?"Symbol(src)_1."+v:"",P=N.toString,W=T.hasOwnProperty,B=T.toString,J=RegExp("^"+P.call(W).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),F=$.Symbol,x=C.splice,K=Q($,"Map"),R=Q(Object,"create"),U=F?F.prototype:void 0,q=U?U.toString:void 0;function z(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function G(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function H(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function L(e,t){for(var r,n,o=e.length;o--;)if((r=e[o][0])===(n=t)||r!=r&&n!=n)return o;return-1}function Y(e,t){var r,n,o=e.__data__;return("string"==(n=typeof(r=t))||"number"==n||"symbol"==n||"boolean"==n?"__proto__"!==r:null===r)?o["string"==typeof t?"string":"hash"]:o.map}function Q(e,t){var r=function(e,t){return null==e?void 0:e[t]}(e,t);return function(e){if(!te(e)||I&&I in e)return!1;var t=function(e){var t=te(e)?B.call(e):"";return"[object Function]"==t||"[object GeneratorFunction]"==t}(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e)?J:D;return t.test(function(e){if(null!=e){try{return P.call(e)}catch(e){}try{return e+""}catch(e){}}return""}(e))}(r)?r:void 0}z.prototype.clear=function(){this.__data__=R?R(null):{}},z.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},z.prototype.get=function(e){var t=this.__data__;if(R){var r=t[e];return"__lodash_hash_undefined__"===r?void 0:r}return W.call(t,e)?t[e]:void 0},z.prototype.has=function(e){var t=this.__data__;return R?void 0!==t[e]:W.call(t,e)},z.prototype.set=function(e,t){return this.__data__[e]=R&&void 0===t?"__lodash_hash_undefined__":t,this},G.prototype.clear=function(){this.__data__=[]},G.prototype.delete=function(e){var t=this.__data__,r=L(t,e);return!(r<0||(r==t.length-1?t.pop():x.call(t,r,1),0))},G.prototype.get=function(e){var t=this.__data__,r=L(t,e);return r<0?void 0:t[r][1]},G.prototype.has=function(e){return L(this.__data__,e)>-1},G.prototype.set=function(e,t){var r=this.__data__,n=L(r,e);return n<0?r.push([e,t]):r[n][1]=t,this},H.prototype.clear=function(){this.__data__={hash:new z,map:new(K||G),string:new z}},H.prototype.delete=function(e){return Y(this,e).delete(e)},H.prototype.get=function(e){return Y(this,e).get(e)},H.prototype.has=function(e){return Y(this,e).has(e)},H.prototype.set=function(e,t){return Y(this,e).set(e,t),this};var V=Z((function(e){var t;e=null==(t=e)?"":function(e){if("string"==typeof e)return e;if(re(e))return q?q.call(e):"";var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}(t);var r=[];return j.test(e)&&r.push(""),e.replace(S,(function(e,t,n,o){r.push(n?o.replace(E,"$1"):t||e)})),r}));function X(e){if("string"==typeof e||re(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}function Z(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw new TypeError("Expected a function");var r=function(){var n=arguments,o=t?t.apply(this,n):n[0],a=r.cache;if(a.has(o))return a.get(o);var s=e.apply(this,n);return r.cache=a.set(o,s),s};return r.cache=new(Z.Cache||H),r}Z.Cache=H;var ee=Array.isArray;function te(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function re(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==B.call(e)}var ne=function(e,t,r){var n=null==e?void 0:function(e,t){var r;t=function(e,t){if(ee(e))return!1;var r=typeof e;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!re(e))||O.test(e)||!w.test(e)||null!=t&&e in Object(t)}(t,e)?[t]:ee(r=t)?r:V(r);for(var n=0,o=t.length;null!=e&&n<o;)e=e[X(t[n++])];return n&&n==o?e:void 0}(e,t);return void 0===n?r:n};const{AWS_REGION:oe,AWS_CHAOS:ae}=process.env,se=h.default,ie=new y.default.Agent({keepAlive:!0}),ce=new m("vernglobe-aws");se.config.update({region:oe,httpOptions:{agent:ie}}),se.config.logger={log:(...e)=>{const t={...e};ce.debug(t)}};const ue=new Map,le={};"string"==typeof ae&&ae.split(",").forEach((e=>{const[t,r,n,o]=e.split("|");le[t]={code:r,message:n,percentage:parseFloat(o)}}),{});var fe=u.default=function(e,t,r,n){const o=ne(se,e);let a;b.default(void 0!==o,`Unable to resolve ${e} via AWS SDK`),ue.has(e)?a=ue.get(e):(a=new o(n),ue.set(e,a));const s=`${e}.${t}`,i=a[t];if(b.default(void 0!==i,`Unable to resolve ${s} via AWS SDK`),le[s]){const{percentage:e,code:t,message:r}=le[s];if(e>(c=0,u=100,c=Math.ceil(c),u=Math.floor(u),Math.floor(Math.random()*(u-c+1))+c)){const e={code:t,message:r};throw Error(JSON.stringify(e))}}var c,u;return a[t](r).promise().catch((o=>{throw ce.error(o),o.message+=` arguments: ${JSON.stringify({service:e,options:n,method:t,parameters:r})}`,o}))},pe={};!function(e){var t;Object.defineProperty(e,"__esModule",{value:!0}),function(e){e[e.Debug=20]="Debug",e[e.Info=30]="Info",e[e.Warn=40]="Warn",e[e.Error=50]="Error"}(t||(t={}));const r=(e,r)=>{e.level=r;const n=JSON.stringify(e);switch(r){case t.Error:console.error(n);break;case t.Warn:console.warn(n);break;case t.Info:console.log(n);break;case t.Debug:console.debug(n);break;default:console.log(n)}},n=e=>"object"==typeof e?e:{message:e};e.default=class{constructor(e){this.name=e}debug(e){r(n({message:e,name:this.name}),t.Debug)}info(e){r(n({message:e,name:this.name}),t.Info)}warn(e){r(n({message:e,name:this.name}),t.Warn)}error(e){const o=n(e);e.error&&(o.error=e.error.stack),o.reason=e.reason,r(o,t.Error)}}}(pe);var de=c(pe);class he{constructor(e){this.id=`${e.icNumber}_${e.name}`,this.registerDt=Date.now(),this.updateDt=Date.now(),this.name=e.name,this.icNumber=e.icNumber,this.email=e.email,this.hpNumber=e.hpNumber,this.birthDt=e.birthDt,this.add1=e.add1,this.add2=e.add2,this.postcode=e.postcode,this.city=e.city,this.state=e.state,this.country=e.country,this.file=e.file}}const ye=new de("vernforever-membership-procesor"),be=process.env.BUCKET,ge=process.env.DYNAMODB_MEMBERSHIP_TABLE;exports.handler=async(e,t)=>{let{body:r}=e,n=200;const o=(e=>{const t=e?JSON.parse(e):null,r={statusCode:200,body:e};t||(r.statusCode=400,r.body="Profile cannot be empty!");const n=t.size?t.size:0;return n<=0&&(r.statusCode=400,r.body="No file uploaded!"),n>=1e6&&(r.statusCode=400,r.body="The file size must less than 1MB!"),(t.profile?t.profile:"")||(r.statusCode=400,r.body="Profile incomplete!"),r})(r);if(200!==o.statusCode)return o;try{switch(e.httpMethod){case"GET":r="";break;case"POST":r=await(async e=>{const t=JSON.parse(e),r=be||"default-bucket-name",n=t.name?t.name:"avenue2022.png",o=Buffer.from(t.file.replace(/^data:image\/\w+;base64,/,""),"base64"),a=t.type?t.type:"image/png",s=new he(t.profile),i=await fe("DynamoDB.DocumentClient","put",{TableName:ge,Item:s});ye.info({respTbl:i});const c=await fe("S3","putObject",{Bucket:r,Key:n,Body:o,ContentEncoding:"base64",ContentType:a});return ye.info({respS3:c}),"Successfully store the file!"})(o.body);break;default:throw new Error(`Unsupported method "${e.httpMethod}"`)}}catch(e){n=400,e instanceof Error&&(r=e.message)}finally{r=JSON.stringify(r)}return{statusCode:n,body:r,headers:{ContentType:"application/json"}}};
